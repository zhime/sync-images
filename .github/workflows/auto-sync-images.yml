name: Auto Sync Images to ACR

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY_URL }}
          namespace: ${{ secrets.ALIYUN_NAMESPACE }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Read YAML and Sync Images
        run: |
          IMAGES_FILE="images.yml"
          while IFS= read -r line; do
            if [[ $line == *":" ]]; then
              REGISTRY=$(echo $line | sed 's/://')
            elif [[ $line == *"- "* ]]; then
              IMAGE=$(echo $line | sed 's/- //')
              echo "Processing $REGISTRY/$IMAGE"
              
              # 获取最新的标签
              TAG_URL="https://$REGISTRY/v2/$IMAGE/tags/list"
              LATEST_TAG=$(curl -s $TAG_URL | grep -oP '(?<="name":")[^"]+' | sort -rV | head -n 1)
              
              if [[ -z "$LATEST_TAG" ]]; then
                echo "No tags found for $REGISTRY/$IMAGE, skipping..."
                continue
              fi

              SOURCE_IMAGE="$REGISTRY/$IMAGE:$LATEST_TAG"
              TARGET_IMAGE="${{ secrets.ALIYUN_REGISTRY_URL }}/${{ secrets.ALIYUN_NAMESPACE }}/$IMAGE:$LATEST_TAG"
              
              echo "Pulling $SOURCE_IMAGE"
              docker pull $SOURCE_IMAGE
              
              echo "Tagging $SOURCE_IMAGE as $TARGET_IMAGE"
              docker tag $SOURCE_IMAGE $TARGET_IMAGE
              
              echo "Pushing $TARGET_IMAGE"
              docker push $TARGET_IMAGE
            fi
          done < $IMAGES_FILE
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

